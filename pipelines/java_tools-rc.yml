---
steps:
  - input: "Release information"
    fields:
      - text: "Version (e.g. 12.1)"
        key: "version"
        required: true      
      - text: "RC (e.g. 1)"
        key: "rc"
        required: true
        default: "1" 
 
  - wait
      
  - label: "Set up"
    agents:
      - "queue=default"
    command: |
      echo "+++ Checking out Git branch"    
      git fetch origin master
      git checkout master
      
      echo "+++ Print latest commit hash"
      echo "commit_hash = \"\${BUILDKITE_COMMIT}\""
      
      # commit_hash=$(git rev-parse HEAD)
      # echo "commit_hash = \"\$commit_hash\""                     
      # buildkite-agent meta-data set "commit_hash" "\$commit_hash"
      
  - wait

  # TO DO
  - label: "Trigger java_tools binaries pipeline"
    trigger: "test-pipeline"
    # trigger: "java-tools-binaries"
    build:
      message: ${BUILDKITE_MESSAGE}
      commit: ${BUILDKITE_COMMIT}
      branch: master

  - block: ":rocket: Create release candidate"

  - label: "Create release candidate"
    agents:
      - "queue=default"
    command: |
      echo "+++ Identify required variables"
      version=$(buildkite-agent meta-data get "version")
      rc=$(buildkite-agent meta-data get "rc")
 
      echo "commit_hash = \"\${BUILDKITE_COMMIT}\""    
      echo "version = \"\$version\""      
      echo "rc = \"\$rc\""      

      echo "+++ Run create_java_tools_release.sh script"
      release_candidates="dummy script output"
      # release_candidates=$(src/create_java_tools_release.sh --commit_hash ${BUILDKITE_COMMIT} --java_tools_version ${version} --rc ${rc} --release false)
      # echo "release_candidates = \"\$release_candidates\""
      buildkite-agent meta-data set "release_candidates" "\$release_candidates"

      # Note: this has to be done through a script since Buildkite doesn't allow passing of meta-data directly to the triggered pipeline yet
      echo "+++ Trigger rules_java-updates pipeline"
      sh trigger-pipeline.sh

  # - wait
  
  # TO DO
  # - label: "Update rules_java"
  #   trigger: "rules-java-updates"
  #   build:
  #     message: ${BUILDKITE_MESSAGE}
  #     env:
  #       release_candidates: "dummy script output"  
  #       release_candidates_buildkite: $(buildkite-agent meta-data get release_candidates)
      
  # - wait
  
  # - label: "Create/update pull request"
  #   agents:
  #     - "queue=default"
  #   command: |
  #     echo "+++ Checking out Git branch"    
  #     git fetch origin master
  #     git checkout master

  #     # release_candidates=$(buildkite-agent meta-data get "release_candidates")
  #     # echo "release_candidates = \"\$release_candidates\""

#  - wait  
  
#  - label: "Trigger downstream build"
#    trigger: 
#      organization: "bazel"
#      pipeline: "bazel-at-head-plus-downstream"
#    soft_fail: true    
#    build:
#      message: "Test"

  
  
