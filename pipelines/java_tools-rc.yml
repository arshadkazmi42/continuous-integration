---
steps:
  - input: "Release information"
    fields:
      - text: "Version (e.g. 12.1)"
        key: "version"
        required: true      
      - text: "RC (e.g. 1)"
        key: "rc"
        required: true
        default: "1" 
      
  - label: "Set up"
    agents:
      - "queue=default"
    command: |
      echo "+++ Checking out Git branch"    
      git fetch origin master
      git checkout master
      
      echo "+++ Getting latest commit hash"
      commit_hash=$(git rev-parse HEAD)
      echo "commit_hash = \"\$commit_hash\""      
      
      buildkite-agent meta-data set "commit_hash" "\$commit_hash"
      
  - wait     
      
  - label: "Trigger java_tools binaries pipeline"
    trigger: "test-pipeline"
    build:
      message: "java_tools release $(buildkite-agent meta-data get \"version\") RC $(buildkite-agent meta-data get \"rc\")"
      commit: $(buildkite-agent meta-data get "commit_hash")
      
  - wait

  - block: ":rocket: Create release candidate"

  - label: "Create release candidate"
    agents:
      - "queue=default"
    command: |
      echo "+++ Checking out Git branch"    
      git fetch origin master
      git checkout master

      commit_hash=$(buildkite-agent meta-data get "commit_hash")
      echo "commit_hash = \"\$commit_hash\""

      version=$(buildkite-agent meta-data get "version")
      echo "version = \"\$version\""

      rc=$(buildkite-agent meta-data get "rc")
      echo "rc = \"\$rc\""
      
      # release_candidates=$(src/create_java_tools_release.sh --commit_hash ${commit_hash} --java_tools_version ${version} --rc ${rc} --release false)
      # echo "release_candidates = \"\$release_candidates\""
      # buildkite-agent meta-data set "release_candidates" "\$release_candidates"

  - wait
  
  - label: "Create/update pull request"
    agents:
      - "queue=default"
    command: |
      echo "+++ Checking out Git branch"    
      git fetch origin master
      git checkout master

      # release_candidates=$(buildkite-agent meta-data get "release_candidates")
      # echo "release_candidates = \"\$release_candidates\""

#  - wait  
  
#  - label: "Trigger downstream build"
#    trigger: "bazel/bazel-at-head-plus-downstream"
#    soft_fail: true    
#    build:
#      message: "Test"

  
  
