---
steps:
  - input: "Artifacts information"
    fields:
      - text: "Artifacts output"
        key: "artifacts"
        required: true
        hint: "Output from create_java_tools_release.sh"
           
  - wait 
      
  - label: "Update rules_java" 
    agents:
      - "queue=default"    
    command: |
      echo "+++ Checking out Git branch"    
      git fetch origin master
      git checkout master

      echo "+++ Identifying required variable"      
      sha=$(buildkite-agent meta-data get "artifacts") 
      echo "sha = \"\$sha\""

      echo "+++ Importing GitHub token"
      github_token=$(gsutil cat gs://bazel-trusted-encrypted-secrets/github-trusted-token.enc | gcloud kms decrypt --project bazel-public --location global --keyring buildkite --key github-trusted-token --ciphertext-file - --plaintext-file -)
      
      echo "+++ Running release updates script"
      git branch keertk-testing
      cd java      
      python3 ../distro/release-updates.py --token "\$github_token" --artifacts "\$sha"
